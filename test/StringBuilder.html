<!DOCTYPE html>
<html>
	<head>
		<title>Darwin Test</title>
	</head>
	<body>
		<script src="../src/Darwin.js" type="text/javascript"></script>
		<script type="text/javascript">
			String.prototype.levenstein = function(string) {
				var a = this, b = string + "", m = [], i, j, min = Math.min;

				if (!(a && b)) return (b || a).length;

				for (i = 0; i <= b.length; m[i] = [i++]);
				for (j = 0; j <= a.length; m[0][j] = j++);

				for (i = 1; i <= b.length; i++) {
					for (j = 1; j <= a.length; j++) {
						m[i][j] = b.charAt(i - 1) == a.charAt(j - 1)
							? m[i - 1][j - 1]
							: m[i][j] = min(
								m[i - 1][j - 1] + 1, 
								min(m[i][j - 1] + 1, m[i - 1 ][j]))
					}
				}

				return m[b.length][a.length];
			}

			String.prototype.hamming = function(string) {
				let diff = 0;
				for(let i = 0; i < this.length; i++) {
					if(this[i] != string.length)
						diff = diff +1;
				}

				return diff;
			}

			String.prototype.cost = function(string) {
				let total = 0;

				for(let i = 0; i < this.length; i++) {
					total += Math.pow(characterSet.indexOf(this[i]) - characterSet.indexOf(string[i]), 2)
				}

				return total;
			}

			String.prototype.cost1 = function(string) {
				let total = 0;

				for(let i = 0; i < this.length; i++) {
					if(this[i] == string[i])
						total += 1;

					total += (Math.abs(characterSet.indexOf(this[i]) - characterSet.indexOf(string[i]), 2)) / characterSet.length;
					//total += (127 - Math.abs(string.charCodeAt(i) - this.charCodeAt(i))) / 50;
				}

				return total;
			}

			let compare = 'Hello world!';

			let characterSet = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ 123456789!';
			
			let d = new Darwin();
				d.template  = new CharChromosome(characterSet, compare.length);
				d.genParams = [];

				d.popSize        = 500;
				d.mutationRate   = 0.5;
				d.crossoverRate  = 0.90;
				d.elitism        = 0.1;
				d.newChromosomes = 0.15;
				d.noBinary       = false;
				d.fittest        = Covington.fittest.biggerIsBetter;

				d.selection = Covington.selection.Rank;
				d.crossover = Covington.crossover.Uniform;
				d.mutation  = Covington.mutation.BitFlip;

				d.newPopulation();
		
			let count = 0;
			let lastSolution = '';
			function loop() {
				let values = d.getPopulation().getGeneValues();
				let combined = [];
				for(let i = 0; i < values.length; i++) {
					combined.push(values[i].join(""));
				}

				for(let i = 0; i < combined.length; i++) {
					d.getPopulation().getChromosomes()[i].setFitness(compare.cost1(combined[i]));
				}

				// console.log(d.getPopulation().topFitness());
				// console.log(d.getPopulation().topIndividual().toString());

				if(!(d.getPopulation().topIndividual().toString() == compare)) {
					if(d.getPopulation().topIndividual().toString() != lastSolution) {
						console.log('Gen ' + count + ' (Fit ' + d.getPopulation().topFitness() + '): ' + d.getPopulation().topIndividual().toString());
						lastSolution = d.getPopulation().topIndividual().toString();
					}

					d.nextGeneration();
					count++;
					setTimeout(loop, 5);
				} else {
					console.log("Solution Found! Took " + count + " generations.");
				}
			}

			loop();
		</script>
	</body>
</html>